:ruby
  disabled_fields = (current_user.has_role?(:inspector) && @inspection.inspection_type.name != 'Initial') ? @inspection.unallowable_inspector_params.map{|x| "##{x}"}.join(',') : ''

= render partial: 'shared/xeditable_scripts'

:javascript

  // ------ override methods in shared xeditable scripts to handle edit/save buttons in different panels -----------
  function open_tab(tab_id) {
    $('.editableform-loading').hide();
    $('.editableform').show();
    $('#' + tab_id).collapse('show');
  }

  $(document).ready(function() {
    $('.inspection-edit-xeditable-button').on('click', function(e) {
      e.stopPropagation();

      //set selected radios
      selected_radio_inputs = $(this).closest('.panel').find('input[type=radio]:checked');

      var tab_id = $(this).parent().parent().parent().parent().parent().find('.panel-collapse').attr('id');

      console.log(tab_id);
      $('#'+tab_id+' .editable-field').not('#{disabled_fields}').editable('enable');
      $('#'+tab_id+' .editable-field').not('#{disabled_fields}').editable('show', false);
      $('#'+tab_id+' input[type=radio]').removeAttr('disabled');
      //$('#'+tab_id+' .editable-input').find('input, select').first().focus();

      $('.other-type-container select').each(function() {
        $(this).closest('.other-type-container').attr('data-original-value', $(this).val());
      });

      // de-focus form: 1. make it select the first one; 2. lost is focus
      // the purpose of selecting first one is to avoid focus jumping to others
      setTimeout(function(){
        $('#'+tab_id+' .editable-input').find('input, select').first().focus();
        $(':focus').blur();
      }, 10);

      $(this).hide();
      $(this).next('.edit-xeditable-buttons').show();
    });

    $('#collapse-profile a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
      tab_id = $('#collapse-profile .tab-pane.active').attr('id')
      if ($('#profile .inspection-edit-xeditable-button').is(":hidden")) {
        $('#'+tab_id+' .editable-field').not('#{disabled_fields}').editable('enable');
        $('#'+tab_id+' .editable-field').not('#{disabled_fields}').editable('show', false);
        $('#'+tab_id+' input[type=radio]').removeAttr('disabled');
        //$('#'+tab_id+' .editable-input').find('input, select').first().focus();

        $('.other-type-container select').each(function() {
          $(this).closest('.other-type-container').attr('data-original-value', $(this).val());
        });

        // de-focus form: 1. make it select the first one; 2. lost is focus
        // the purpose of selecting first one is to avoid focus jumping to others
        setTimeout(function(){
          $('#'+tab_id+' .editable-input').find('input, select').first().focus();
          $(':focus').blur();
        }, 10);
      } else {
        $('#'+tab_id+' input[type=radio]').attr('disabled', 'true');
        $('#'+tab_id+' .editable-field').editable('hide');
        $('#'+tab_id+' .editable-field').editable('disable');
      }
    });
  });
  // ----------------------------------------------------------------------------------------------------------------

  var user_tab_key = 'inspection_tab_key';

  // Override placement of validator msg on .input-groups
  $.validator.setDefaults({errorPlacement: function(error, element) {
      console.log(element);
      if(element.parents('.input-group').length) {
        error.insertAfter(element.parents('.input-group'));
      } else {
        error.insertAfter(element);
      }
    }
  });

  $(document).ready(function() {

    // transam.make_same_height('.header-part');

    // Manage the tabs
    $('a[data-toggle="tab"]').on('shown.bs.tab', function(e) {
      // save the latest tab
      var this_tab = $(this).attr('href');
      transam.set_ui_key_value(user_tab_key, this_tab);
    });
  });
  $(function() {
    var last_tab = transam.get_ui_key_value(user_tab_key);
    if (last_tab) {
      $('a[href="'+last_tab+'"]').tab('show');
    } else {
      // Default to the first tab if no tab is stored
      $('a[data-toggle="tab"]:first').tab('show');
    }
  });
