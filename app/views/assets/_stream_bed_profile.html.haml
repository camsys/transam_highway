:ruby
  table_dom_id = SecureRandom.hex

.row
  .col-sm-12
    .panel.panel-default
      .panel-heading
        %h3.panel-title
          %a{data: {toggle: 'collapse'}, href: '#collapse-streambed'}Streambed Profile
          - if can? :update, @asset
            .btn-group.pull-right.panel-action
              %div
                %button.btn.btn-primary.edit-streambed-profiles-button
                  Edit
              .save-streambed-profiles-buttons{style: 'display: none;'}
                %button.btn.btn-primary.save-streambed-profiles-button
                  Save
                %button.btn.btn-primary.cancel-streambed-profiles-button
                  Cancel
      #collapse-streambed.panel-collapse.collapse.in
        .panel-body
          .row
            .col-sm-12
              #streambed_table_actions.btn-toolbar
                - if can? :update, @asset
                  .btn-group
                    = link_to new_streambed_profile_path(transam_asset_id: @asset.object_key), remote: true, class: 'btn btn-primary', title: 'New Profile' do
                      %i.fa.fa-plus
                      = " New Profile"
                - if @asset.streambed_profiles.where(inspection_id: nil).last
                  .btn-group
                    = link_to new_streambed_profile_streambed_profile_point_path(@asset.streambed_profiles.where(inspection_id: nil).last), remote: true, class: 'btn btn-primary', title: 'New Distance' do
                      %i.fa.fa-plus
                      = " New Distance"
              .table-responsive#streambed_table
                -# Remove .table-hover with data-classes
                %table{:id => table_dom_id,
                        :data => {:toggle => 'table',
                        :card_view => "false",
                        :classes => 'table',
                        :pagination => 'false',
                        :sort_order => 'asc',
                        :sortable => 'false',
                        :search => 'false',
                        :show_columns => 'false',
                        :toolbar => "#streambed_table_actions",
                        :row_style => 'row_style',
                        :click_to_select => 'false',
                        :show_export => 'true',
                        :id_field => 'object_key',
                        :export_types => "['csv', 'txt', 'excel']",
                        :cookie => 'true',
                        :cookie_id_table => "inspections_id",
                        :cookie_expire => "1y",
                        :maintain_selected => 'true',
                        :single_select => 'false'}}
                  %thead
                    %tr
                      %th.center Inspection Year
                      - cols = @asset.streambed_profiles.first.try(:all_possible_distances) || []
                      - cols.each do |distance|
                        %th.center= distance
                      %th.center Water Level

                  %tbody
                    - @asset.streambed_profiles.each do |profile|
                      %tr
                        %td.center= profile.date.year
                        - cols.each do |distance|
                          %td.center
                            - profile_point = profile.streambed_profile_points.find_by(distance: distance)
                            - if (can? :update, @asset) && profile.inspection.nil?
                              - if profile_point
                                %span.number-display
                                  = format_as_decimal(profile_point.value,1)
                                %input.number-input.form-control{style: 'display: none;', type: 'number', required: 'required', min: 0, value: profile_point.value, data: {streambed_profile: profile.object_key, streambed_profile_point: profile_point.object_key}}
                              - else
                                %input.number-input.form-control{style: 'display: none;', type: 'number', required: 'required', min: 0, data: {streambed_profile: profile.object_key, distance: distance}}
                            - else
                              = format_as_decimal(profile_point.value,1) if profile_point
                        %td.center
                          - if (can? :update, @asset) && profile.inspection.nil?
                            %span.number-display
                              = format_as_decimal(profile.water_level,1)
                            %input.water-level.number-input.form-control{style: 'display: none;', type: 'number', required: 'required', min: 0, value: profile.water_level, data: {streambed_profile: profile.object_key}}
                          - else
                            = format_as_decimal(profile.water_level,1)


:javascript
  $(function() {
    $('.edit-streambed-profiles-button').on('click', function() {
      $('.edit-streambed-profiles-button').hide();
      $('.save-streambed-profiles-buttons').show();
      enable_streambed_profile_editing();
    });
    $('.save-streambed-profiles-button').on('click', function() {
      submit_streambed_profile_changes();
    });
    $('.cancel-streambed-profiles-button').on('click', function() {
      // reload
      window.location.href = "#{inventory_path(@asset.object_key)}";
      window.location.reload();
    });
  });

  function enable_streambed_profile_editing() {
    $('#streambed_table .number-display').hide();
    $('#streambed_table .number-input').show();
  }

  function submit_streambed_profile_changes() {
    $("#spinner").show();

    var targets = {};
    $( "#streambed_table input:not(.water-level)" ).each(function( index ) {
      if (!targets[$(this).data('streambed-profile')]) {
        targets[$(this).data('streambed-profile')] = {};
      }

      if (($(this).data('streambed-profile-point')) && ($(this).data('streambed-profile-point').length > 0)) {
        targets[$(this).data('streambed-profile')][$(this).data('streambed-profile-point')] = $(this).val();
      } else if (($(this).data('distance')) && ($(this).data('distance').length > 0)) {
        targets[$(this).data('streambed-profile')] [$(this).data('distance')] = $(this).val();
      }
    });


    var water_levels = {};
    $( "#streambed_table input.water-level" ).each(function( index ) {
      water_levels[$(this).data('streambed-profile')] = $(this).val();
    });

    $.ajax({
      url: "#{update_many_streambed_profiles_path}",
      method: 'put',
      data: {
        targets: targets,
        water_levels: water_levels
      },
      success: function() {
        $("#spinner").hide();
        window.location.reload();
      },
      failure: function() {
        $("#spinner").hide();
        alert('An error occurred saving the changes. Please try again.');
      }
    })
  }